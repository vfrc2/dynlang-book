\documentclass[10pt]{book}
\usepackage[width=5.5in,height=8.5in,hmarginratio=3:2,vmarginratio=1:1]{geometry}

\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage{hyperref}
%\usepackage{listings}

\begin{document}
	\title{Динамические формы: Исчерпывающее руководство для новичков}
	\author{Кирилл Кривошеев}

	\maketitle
	\tableofcontents
	\mainmatter
	
	\chapter{Введение}
	
	\section{Что такое программа}
	
	\section{Запуск динамических команд}
	Одним из первых вызовов, который бросает динамический язык начинающему разработчику, является необходимость настройки рабочего окружения HP Service Manager для редактирования шаблонов динамических форм. Однако, благодаря мощным возможностям динамического языка, сделать первые шаги в разработке можно гораздо проще: достаточно открыть шаблон обращения <<Исполнятор>> в dev-среде портала <<Лицо ДРУГа>>. Это простая динамическая форма, состящая всего из двух полей: <<Команда>> и <<Результат>>.
	
	\section{Первая программа}
	
	По давней традиции, первая программа, которую начинающий разработчик пишет на новом языке, является <<Hello, world!>>. На динамическом языке она выглядит так:
	\begin{verbatim}
	>>> setValue([Hello, world!],[result])
	\end{verbatim}
	
	Для выполнения программы введите ее в поле <<Команда>> и переставьте курсор в поле <<Результат>>. В итоге, в поле <<Результат>> вы увидите текст:
	
	\begin{verbatim}
	Hello, World!
	\end{verbatim}
	
	Поздравляем! Вы сделали первый шаг на безумно интересном пути к освоению могучих возможностей создани интерактивных форм, который дает вам Динамический язык.
	Это пример команды {\bf setValue}, которая устанавливает значение, указанное первым аргументом в квадратных скобках в поле, указанное во втором аргументе.
	
	Здесь и далее, все команды, которые вводятся в поле <<Команда>> будут предваряться символами 	\begin{verbatim}
	>>>
	\end{verbatim}	За которыми следует результат выполнения в поле <<Результат>>
	
	\section{Чувствительность к регистру}
	
	Динамческий язык нечувствителен к регистру. Это означает, что программы:
	
	\begin{verbatim}
	>>> setvalue([Hello, world!],[result])
	\end{verbatim}
	
	и
	
	\begin{verbatim}
	>>> setvalue([Hello, world!],[result])
	\end{verbatim}
	
	и даже
	
	\begin{verbatim}
	>>> sEtVaLuE([Hello, world!],[result])
	\end{verbatim}
	
	C точки зрения интерпретатора динамического языка являются индентичными и произведут одинаковый результат. И несмотря на то, что последний пример выглядит, безусловно, наиболее круто, в примерах к книге мы будем придерживаться так называемого CamelCase, так как он наиболее удобочитаем:
	
	\begin{verbatim}
	>>> setValue([Hello, world!],[result])
	\end{verbatim}
	
	\section{Арифметические функции}
	
	Перейдем от <<Hello, world!>> к арифметике. Как и любой, уважающий себя язык программирования, динамический язык предоставляет возможность работы с основными арифметическими операциями, а именно {\bf plus}, {\bf minus} и {\bf mul} для сложения, вычитания и умножения, а также {\bf div} для деления:
	
	\begin{verbatim}
	>>> setValue([plus([68],[1])],[result])
	69
	>>> setValue([minus([69],[1])],[result])
	68
	>>> setValue([mul([6],[7])],[result])
	42
	>>> setValue([div([84],[2])],[result])
	42
	\end{verbatim}
	
	На самом деле, указанные функции обладают гораздо большим набором возможностей, но для первого знакомства этого будет достаточно. 
				
	\section{Упражнения}
	
	Откройте шаблон <<Исполнятор>> и решите следующие задачи:
	
	\begin{enumerate}
		\item Сколько будет в градусах Цельсия температура в 69 Фаренгейт?
		
		\item Сколько спринтов потребуется для вывода в промышленную эксплуатацию шаблона <<Совместная поездка>> если каждый спринт исправляется 6 багов, и обнаруживается 4 новых?
	\end{enumerate}
	
	
	% Структура программы =====================================================================
	\chapter{Структура программы}
	
	\section{Значения и типы}
	
	\section{Идентификаторы}
	
	\section{Возвращаемые значения}
	
	\section{Порядок выполнения}
	
	\section{Функция call}
	
	\section{Операторы ветвления}
	
	\section{Циклы}
	\label{sec:loops}
	
	Вооружившись ранее изученным набором команд, вам не составит труда реализовать цикл на динамическом языке.
	
	Напишем программу, которая выведет в поле <<Результат>> 100 точек:
	
	Добавьте  на динамическую форму скрытое поле с 'id' : 'counter'. Это поле будет служить счетчиком цикла.
	
	Ниже приведен полный листинг программы:
	
	\begin{verbatim}
	if(
	    [isnotin([getValue([counter])],[100])],
	       [run(
	           [setValue(
	               [plus(
	                   [getValue([result])],
	                   [.]
                   )],
	              [result]
	           )],
               [setValue(
	               [plus(
	                   [getValue([counter])],
	                   [1]
	               )],
	               [counter]
	           )],
	           [call(
	               [getValue([cmd])],
	               [this]
	           )]
	      )]
	)]
	\end{verbatim}
	
	Запустив программу, можно убедиться, что в поле <<Результат>> вывелось ровно 100 точек.
	
	Теперь рассмотрим принцип работы программы подробнее:
	
	\begin{verbatim}
	if(
	    [isnotin([getValue([counter])],[100])],
	\end{verbatim}
	
	В данном фрагменте кода мы проверяем, не выполняется ли условие неравенства нашего счетчика значению 100.
	
	В этом случае выполняем тело цикла, состоящее из 3-x команд внутри блока <<run>>:
	
	\begin{verbatim}
	setValue([plus([getValue([result])],[.])],[result])
	\end{verbatim}
	
	Здесь происходит добавление новой точки в поле с результатом.
	
	\begin{verbatim}
	setValue([plus([getValue([counter])],[1])],[counter])
	\end{verbatim}
	
	Увеличиваем значение счетчика на 1.
	
	\begin{verbatim}
	call([getValue([cmd])],[this])
	\end{verbatim}
	
	И, главная часть, обеспечивающая зацикливание нашей программы - вызываем повторное выполнение скрипта при помощи функции
	<<Call>>
	
	\section{Упражнения}
	
	Откройте шаблон <<Исполнятор>> и решите следующие задачи:
	
	\begin{enumerate}
	\item Напишите программу, которая выводит на экран числа от 1 до 100. При этом вместо чисел, кратных трем, программа должна выводить слово «Fizz», а вместо чисел, кратных пяти — слово «Buzz». Если число кратно и 3, и 5, то программа должна выводить слово «FizzBuzz»
	
	\end{enumerate}
	
	% Динамическая форма =====================================================================
	\chapter{Динамическая форма}
	
	\section{Что такое динамическая форма?}
	
	\section{Текстовые поля}
	
	\section{Списки}
	
	\section{Чекбоксы}
	
	% Группы ==================================================================================
	\chapter{Группы}
	
	\section{Виды групп}
	
	\section{Копирование групп}
	
	\section{Удаление групп}
	
	% Асинхронность ===========================================================================
	\chapter{Асинхронные команды}
	
	\section{Автоисполнятор}
	
	\section{Сопрограммы}

	% Паттерны ================================================================================
	\chapter{Паттерны программирования на динамическом языке}
	
	\section{Выделение функций}
	
Рассмотрим задачу формирования списка месяцев в зависимости от текущей даты: в элемент типа select требуется вывести название текущего и двух последующих месяцев. Вот как реализована эта функция в одном из шаблонов обращений:

\begin{verbatim}

if(
    [isin(
        [substr([getsysdate([+0])],[3],[5])],
        [01]
    )],
    [setSelectedValue(
        [null],
        [setValue(
            [Март],
            [setValue(
                [Февраль],
                [setValue(
                    [Январь],
                    [this]
                )]
            )]
        )]
    )],
    [if(
        [isin(
            [substr([getsysdate([+0])],[3],[5])],
            [02]
        )],
        [setSelectedValue(
            [null],
            [setValue(
                [Апрель],
                [setValue(
                    [Март],
                    [setValue(
                        [Февраль],
                        [this]
                    )]
                )]
            )]
        )],
        [if(
            [isin(
                [substr([getsysdate([+0])],[3],[5])],
                [03]
            )],
            [setSelectedValue(
                [null],
                [setValue(
                    [Май],
                    [setValue(
                        [Апрель],
                        [setValue(
                            [Март],
                            [this]
                        )]
                    )]
                )]
            )],
            [if(
                [isin(
                    [substr([getsysdate([+0])],[3],[5])],
                    [04]
                )],
                [setSelectedValue(
                    [null],
                    [setValue(
                        [Июнь],
                        [setValue(
                            [Май],
                            [setValue(
                                [Апрель],
                                [this]
                            )]
                        )]
                    )]
                )],
                [if(
                    [isin(
                        [substr([getsysdate([+0])],[3],[5])],
                        [05]
                    )],
                    [setSelectedValue(
                        [null],
                        [setValue(
                            [Июль],
                            [setValue(
                                [Июнь],
                                [setValue(
                                    [Май],
                                    [this]
                                )]
                            )]
                        )]
                    )],
                    [if(
                        [isin(
                            [substr([getsysdate([+0])],[3],[5])],
                            [06]
                        )],
                        [setSelectedValue(
                            [null],
                            [setValue(
                                [Август],
                                [setValue(
                                    [Июль],
                                    [setValue(
                                        [Июнь],
                                        [this]
                                    )]
                                )]
                            )]
                        )],
                        [if(
                            [isin(
                                [substr([getsysdate([+0])],[3],[5])],
                                [07]
                            )],
                            [setSelectedValue(
                                [null],
                                [setValue(
                                    [Сентябрь],
                                    [setValue(
                                        [Август],
                                        [setValue(
                                            [Июль],
                                            [this]
                                        )]
                                    )]
                                )]
                            )],
                            [if(
                                [isin(
                                    [substr([getsysdate([+0])],[3],[5])],
                                    [08]
                                )],
                                [setSelectedValue(
                                    [null],
                                    [setValue(
                                        [Октябрь],
                                        [setValue(
                                            [Сентябрь],
                                            [setValue(
                                                [Август],
                                                [this]
                                            )]
                                        )]
                                    )]
                                )],
                                [if(
                                    [isin(
                                        [substr([getsysdate([+0])],[3],[5])],
                                        [09]
                                    )],
                                    [setSelectedValue(
                                        [null],
                                        [setValue(
                                            [Ноябрь],
                                            [setValue(
                                                [Октябрь],
                                                [setValue(
                                                    [Сентябрь],
                                                    [this]
                                                )]
                                            )]
                                        )]
                                    )],
                                    [if(
                                        [isin(
                                            [substr([getsysdate([+0])],[3],[5])],
                                            [10]
                                        )],
                                        [setSelectedValue(
                                            [null],
                                            [setValue(
                                                [Декабрь],
                                                [setValue(
                                                    [Ноябрь],
                                                    [setValue(
                                                        [Октябрь],
                                                        [this]
                                                    )]
                                                )]
                                            )]
                                        )],
                                        [if(
                                            [isin(
                                                [substr([getsysdate([+0])],[3],[5])],
                                                [11]
                                            )],
                                            [setSelectedValue(
                                                [null],
                                                [setValue(
                                                    [Январь],
                                                    [setValue(
                                                        [Декабрь],
                                                        [setValue(
                                                            [Ноябрь],
                                                            [this]
                                                        )]
                                                    )]
                                                )]
                                            )],
                                            [if(
                                                [isin(
                                                    [substr([getsysdate([+0])],[3],[5])],
                                                    [12]
                                                )],
                                                [setSelectedValue(
                                                    [null],
                                                    [setValue(
                                                        [Февраль],
                                                        [setValue(
                                                            [Январь],
                                                            [setValue(
                                                                [Декабрь],
                                                                [this]
                                                            )]
                                                        )]
                                                    )]
                                                )],
                                                []
                                            )]
                                        )]
                                    )]
                                )]
                            )]
                        )]
                    )]
                )]
            )]
        )]
    )]
)
\end{verbatim}

Как видим, данный пример содержит много повторяющихся элементов участков кода - по одному фрагменту на каждый из 12 месяцев. Хорошо, что в нашем календаре их не 42! Представьте объем доработок при изменении требований к задаче: например, заказчику потребуется выводить по 6 названий месяцев!

Приступим же к рефакторингу!

Первым делом, обратим внимание на повторяющийся фрагмент кода:

\begin{verbatim}
[substr([getsysdate([+0])],[3],[5])]
\end{verbatim}

Это скрипт получения значения номера текущего месяца.
Вычислим его один раз и запомним в отдельном скрытом поле формы:

\begin{verbatim}
<text id="month_num" visible="false"
        sbcommand="setValue([substr([getsysdate([+0])],[3],[5])],[this])]" 
 />
\end{verbatim}

Далее, нам потребуется структура для выставляения соответствия номерам месяцев их названий. С этой задачей отлично справляется элемент <<select>> :

\begin{verbatim}
<select id="months" visible="false"> 

<option label="Январь">1</option>
<option label="Февраль">2</option>
<option label="Март">3</option>
<option label="Апрель">4</option>
<option label="Май">5</option>
<option label="Июнь">6</option>
<option label="Июль">7</option>
<option label="Август">8</option>
<option label="Сентябрь">9</option>
<option label="Октябрь">10</option>
<option label="Ноябрь">11</option>
<option label="Декабрь">12</option>
<option label="Январь">13</option>
<option label="Февраль">14</option>

</select>
\end{verbatim}

Обратите внимание, что мы указали 2 <<лишних>> месяца -- это потребуется для корректной работы нашего алгоритма в ноябре и декабре.

Добавим на динамическую форму select для вывода результата:
\begin{verbatim}
<select id="result" visible="true"> 
\end{verbatim}

Реализуем функцию добавления в наш новый контрол очередного месяца:

\begin{verbatim}
<text id="add_month">
setValue(
    [getValue(
        [setSelectedValue(
            [plus(
                [getValue([month_num])],
                [getValue([i])]
            )], 
            [months]
        )],
        [result]
    )],
    [result]
)
</text>
\end{verbatim}

Где <<i>> - простое скрытое поле для хранения счетчика:
\begin{verbatim}
<text id="month_num" visible="false">0</text>
\end{verbatim}

Для добавления нового месяца в итоговый select достаточно выполнить вызвать нашу функцию <<add\_month>> через оператор call: 

\begin{verbatim}
call([getValue([add_month])],[this])
\end{verbatim}

Теперь, для решения нашей задачи потребуется выполнить скрипт <<add\_month>> трижды, меняя значение <<i>>:

\begin{verbatim}
run(
    [call([getValue([add_month])],[this])],
    [setValue([1],[i])],
    [call([getValue([add_month])],[this])],
    [setValue([2],[i])],
    [call([getValue([add_month])],[this])],
    [setSelectedValue([null],[result])]
)
\end{verbatim}

\section{Упражнения}

\begin{enumerate}
	\item Используя код разобранного выше примера, решите задачу: в элемент типа select требуется вывести название текущего и 5 последующих нечетных месяцев. Для решения задачи рекомендуется использовать подход к реализации циклов, рассмотренный в  \autoref{sec:loops}
	
\end{enumerate}


\end{document}
